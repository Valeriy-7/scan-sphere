"use strict";(()=>{var e={};e.id=670,e.ids=[670],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11992:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>m,serverHooks:()=>g,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>x});var o={};r.r(o),r.d(o,{GET:()=>d,POST:()=>l});var s=r(96559),i=r(48088),n=r(37719),a=r(32190),p=r(97151),c=r(82997);function u(e){return e.toLocaleDateString("ru-RU")}async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("articleId"),o=t.get("limit")?parseInt(t.get("limit")):10,s=t.get("query");try{let e=await p.A.searchQuery.findMany({orderBy:{createdAt:"desc"},take:2*o,include:{products:!0,positions:{include:{product:!0}}}});r&&(e=e.filter(e=>e.products.some(e=>e.article===r))),s&&(e=e.filter(e=>e.query.toLowerCase()===s.toLowerCase()),r&&(e=e.slice(0,1)));let t=(e=(e=e.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())).slice(0,o)).map(e=>{let t=e.products.find(e=>!e.isCompetitor),r=e.products.find(e=>e.isCompetitor),o=c.M.map(t=>{let r=e.positions.find(e=>e.city===t&&!1===e.product.isCompetitor),o=e.positions.find(e=>e.city===t&&!0===e.product.isCompetitor),s=r?.position||0,i=r?.page||0,n=o?.position||0,a=o?.page||0;return{city:t,rank:s,pageRank:i,competitorRank:n>0?n:void 0,competitorPageRank:a>0?a:void 0}}).filter(e=>e.rank>0);return{id:e.id.toString(),date:u(e.createdAt),query:e.query,myArticleId:t?.article||"",competitorArticleId:r?.article||"",positions:o,hasCompetitor:!!r?.article}});if(0===t.length)return a.NextResponse.json([]);return a.NextResponse.json(t)}catch(e){return console.error("Ошибка при запросе к БД:",e),a.NextResponse.json({error:"Ошибка при получении данных из БД"},{status:500})}}catch(e){return console.error("Ошибка при получении истории:",e),a.NextResponse.json({error:"Произошла ошибка при обработке запроса"},{status:500})}}async function l(e){try{let t=await e.json();if(!t.query||!t.myArticleId||!t.competitorArticleId||!t.positions)return a.NextResponse.json({error:"Не указаны все обязательные поля"},{status:400});try{let e=await p.A.searchQuery.create({data:{query:t.query,products:{create:[{article:t.myArticleId,isCompetitor:!1},{article:t.competitorArticleId,isCompetitor:!0}]},positions:{createMany:{data:t.positions.map(e=>({city:e.city,position:e.rank,page:e.pageRank,productId:e.isCompetitor?t.competitorArticleId:t.myArticleId}))}}},include:{products:!0,positions:!0}}),r={id:e.id.toString(),date:u(e.createdAt),query:e.query,myArticleId:t.myArticleId,competitorArticleId:t.competitorArticleId,positions:t.positions,hasCompetitor:!!t.competitorArticleId};return a.NextResponse.json(r,{status:201})}catch(e){return console.error("Ошибка при сохранении в БД:",e),a.NextResponse.json({error:"Ошибка при сохранении данных в базу"},{status:500})}}catch(e){return console.error("Ошибка при создании записи в истории:",e),a.NextResponse.json({error:"Произошла ошибка при обработке запроса"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/history/route",pathname:"/api/history",filename:"route",bundlePath:"app/api/history/route"},resolvedPagePath:"/Users/biveki/Desktop/Projects/openparsersferav/src/app/api/history/route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:y,workUnitAsyncStorage:x,serverHooks:g}=m;function h(){return(0,n.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:x})}},21820:e=>{e.exports=require("os")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79646:e=>{e.exports=require("child_process")},79748:e=>{e.exports=require("fs/promises")},82997:(e,t,r)=>{r.d(t,{D:()=>s,M:()=>o});let o=["Москва","СПб","Казань","Краснодар","Екатеринбург","Новосибирск","Хабаровск","Владивосток"],s={Москва:"msk",СПб:"spb",Казань:"kzn",Краснодар:"krd",Екатеринбург:"ekb",Новосибирск:"nsk",Хабаровск:"khb",Владивосток:"vvo"}},83997:e=>{e.exports=require("tty")},84297:e=>{e.exports=require("async_hooks")},94735:e=>{e.exports=require("events")}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[447,580,363],()=>r(11992));module.exports=o})();